<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" lang="el" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <title>FitTrack - User Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: 1px solid #dee2e6; }
        /* Style for disabled dates in flatpickr */
        .flatpickr-day.flatpickr-disabled {
            color: rgba(57,57,57,0.3) !important;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">FitTrack</a>
        <div class="d-flex align-items-center">
            <span class="text-white me-3" th:if="${user != null}" th:text="${user.firstName + ' ' + user.lastName}">User</span>
            <form th:action="@{/logout}" method="POST">
                <button type="submit" class="btn btn-outline-light btn-sm">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <!-- Appointments Section -->
    <section class="mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¡Î±Î½Ï„ÎµÎ²Î¿Ï</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <form id="bookingForm">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <div class="mb-3">
                                <label class="form-label">Î•Ï€Î¹Î»Î¿Î³Î® Î ÏÎ¿Ï€Î¿Î½Î·Ï„Î®</label>
                                <select id="trainerSelect" name="trainerId" class="form-select" required>
                                    <option value="">-- Î•Ï€Î¹Î»Î­Î¾Ï„Îµ --</option>
                                    <option th:each="trainer : ${trainers}"
                                            th:value="${trainer.id}"
                                            th:data-specialisation="${trainer.specialisation}"
                                            th:text="${trainer.firstName + ' ' + trainer.lastName + (trainer.specialisation != null ? ' - ' + trainer.specialisation : '')}">
                                    </option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-7 mb-3">
                                    <label class="form-label">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
                                    <input type="text" id="scheduledDate" class="form-control" placeholder="Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±..." required />
                                    <small class="text-muted">ÎŸÎ¹ Î³ÎºÏÎ¯Î¶ÎµÏ‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚</small>
                                </div>
                                <div class="col-md-5 mb-3">
                                    <label class="form-label">ÎÏÎ± (09:00-21:00)</label>
                                    <input type="text" id="scheduledTime" class="form-control" placeholder="Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏÏÎ±" required readonly />
                                </div>
                            </div>
                            <input type="hidden" id="scheduledAt" name="scheduledAt" />

                            <!-- Outdoor Training Location Fields -->
                            <div id="locationFields" style="display: none;">
                                <div class="alert alert-info small mb-3">
                                    ğŸŒ¤ï¸ Î”ÏÏƒÏ„Îµ Ï„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î®/Ï€ÏŒÎ»Î· Î³Î¹Î± Ï„Î·Î½ Ï…Ï€Î±Î¯Î¸ÏÎ¹Î± Ï€ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ·
                                </div>

                                <!-- Location Input -->
                                <div class="mb-3">
                                    <label class="form-label">Î ÎµÏÎ¹Î¿Ï‡Î® / Î ÏŒÎ»Î·</label>
                                    <div class="input-group">
                                        <input type="text" id="postalCodeInput" class="form-control" placeholder="Ï€.Ï‡. Î‘Î¸Î®Î½Î±, Î’ÏÏÏ‰Î½Î±Ï‚, Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·" />
                                        <button type="button" id="lookupPostalCode" class="btn btn-outline-dark">
                                            ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
                                        </button>
                                    </div>
                                    <small id="postalCodeFeedback" class="form-text"></small>
                                </div>

                                <input type="hidden" name="latitude" id="hiddenLatitude" />
                                <input type="hidden" name="longitude" id="hiddenLongitude" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
                                <textarea name="userNotes" class="form-control" rows="2" placeholder="Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-dark">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î¡Î±Î½Ï„ÎµÎ²Î¿Ï</button>
                            <div id="bookingMessage" class="mt-2" style="display: none;"></div>
                        </form>
                    </div>
                    <div class="col-md-7">
                        <h6>Î¤Î± Î¡Î±Î½Ï„ÎµÎ²Î¿Ï Î¼Î¿Ï…</h6>
                        <div th:if="${appointments != null and !appointments.isEmpty()}">
                            <div th:each="appt : ${appointments}" class="border rounded p-2 mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <strong th:text="${appt.trainer.firstName + ' ' + appt.trainer.lastName}">Trainer</strong>
                                        <span th:if="${appt.trainer.specialisation != null}" class="text-muted" th:text="${' (' + appt.trainer.specialisation + ')'}"></span>
                                        <br>
                                        <small th:if="${appt.scheduledAt != null}"
                                               th:text="${#temporals.format(appt.scheduledAt, 'dd/MM/yyyy HH:mm')}">Date</small>
                                        <br th:if="${appt.trainingType != null and appt.trainingType.toString() == 'OUTDOOR_TRAINING'}">
                                        <small th:if="${appt.trainingType != null and appt.trainingType.toString() == 'OUTDOOR_TRAINING'}" class="text-info">
                                            <i>ğŸŒ¤ï¸ Î¥Ï€Î±Î¯Î¸ÏÎ¹Î± Î ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ·</i>
                                        </small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <div>
                                            <span class="badge bg-warning text-dark" th:if="${appt.status.name() == 'REQUESTED'}">Î£Îµ Î±Î½Î±Î¼Î¿Î½Î®</span>
                                            <span class="badge bg-dark" th:if="${appt.status.name() == 'CONFIRMED'}">Î•Ï€Î¹Î²ÎµÎ²Î±Î¹Ï‰Î¼Î­Î½Î¿</span>
                                            <span class="badge bg-secondary" th:if="${appt.status.name() == 'COMPLETED'}">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ</span>
                                        </div>
                                        <button th:if="${appt.trainingType != null and appt.trainingType.toString() == 'OUTDOOR_TRAINING' and appt.latitude != null and appt.longitude != null}"
                                                class="btn btn-sm btn-outline-primary weather-btn"
                                                th:data-appointment-id="${appt.id}"
                                                title="Î ÏÎ¿Î²Î¿Î»Î® ÎšÎ±Î¹ÏÎ¿Ï">
                                            â˜€ï¸ ÎšÎ±Î¹ÏÏŒÏ‚
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p th:if="${appointments == null or appointments.isEmpty()}" class="text-muted mb-0">
                            Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÏÎ±Î½Ï„ÎµÎ²Î¿Ï Î±ÎºÏŒÎ¼Î±.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Section -->
    <section class="mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white"><h5 class="mb-0">Î ÏÎ¿Ï†Î¯Î»</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p th:if="${user != null}">
                            <strong>ÎŒÎ½Î¿Î¼Î±:</strong> <span th:text="${user.firstName}"></span> <span th:text="${user.lastName}"></span><br>
                            <strong>Email:</strong> <span th:text="${user.emailAddress}"></span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Î£Ï„ÏŒÏ‡Î¿Î¹</h6>
                        <div th:if="${goals != null and !goals.isEmpty()}">
                            <span th:each="goal : ${goals}" class="badge bg-secondary me-1 mb-1" th:text="${goal}"></span>
                        </div>
                        <form th:action="@{/profile/add-goal}" method="POST" class="mt-2">
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" name="goal" required>
                                    <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÏ„ÏŒÏ‡Î¿...</option>
                                    <option value="Î‘Ï€ÏÎ»ÎµÎ¹Î± Î²Î¬ÏÎ¿Ï…Ï‚">Î‘Ï€ÏÎ»ÎµÎ¹Î± Î²Î¬ÏÎ¿Ï…Ï‚</option>
                                    <option value="ÎœÏ…ÏŠÎºÎ® ÎµÎ½Î´Ï…Î½Î¬Î¼Ï‰ÏƒÎ·">ÎœÏ…ÏŠÎºÎ® ÎµÎ½Î´Ï…Î½Î¬Î¼Ï‰ÏƒÎ·</option>
                                    <option value="ÎšÎ±ÏÎ´Î¹Î±Î³Î³ÎµÎ¹Î±ÎºÎ®">ÎšÎ±ÏÎ´Î¹Î±Î³Î³ÎµÎ¹Î±ÎºÎ®</option>
                                    <option value="Î•Ï…Î»Ï…Î³Î¹ÏƒÎ¯Î±">Î•Ï…Î»Ï…Î³Î¹ÏƒÎ¯Î±</option>
                                </select>
                                <button type="submit" class="btn btn-dark btn-sm">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Progress Section -->
    <section class="mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white"><h5 class="mb-0">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î ÏÎ¿ÏŒÎ´Î¿Ï…</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <form th:action="@{/profile/add-progress}" method="POST">
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label class="form-label">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
                                    <input type="date" class="form-control form-control-sm" name="date" required />
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Î’Î¬ÏÎ¿Ï‚ (kg)</label>
                                    <input type="number" step="0.1" class="form-control form-control-sm" name="weight" />
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label class="form-label">Î”Î¹Î¬ÏÎºÎµÎ¹Î± Î ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ·Ï‚ (Î»ÎµÏ€Ï„Î¬)</label>
                                    <input type="number" class="form-control form-control-sm" name="workoutDuration" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Î•Î¯Î´Î¿Ï‚ Î†ÏƒÎºÎ·ÏƒÎ·Ï‚</label>
                                    <select class="form-select form-select-sm" name="trainingType">
                                        <option value="">-- Î•Ï€Î¹Î»Î­Î¾Ï„Îµ --</option>
                                        <option value="AEROBIC">Î‘ÎµÏÏŒÎ²Î¹Î±</option>
                                        <option value="CARDIO">ÎšÎ±ÏÎ´Î¹Î±Î³Î³ÎµÎ¹Î±ÎºÎ®</option>
                                        <option value="STRENGTH_TRAINING">Î•Î½Î´Ï…Î½Î¬Î¼Ï‰ÏƒÎ·</option>
                                        <option value="FLEXIBILITY_AND_STRETCHING">Î•Ï…Î»Ï…Î³Î¹ÏƒÎ¯Î±</option>
                                        <option value="BALANCE_TRAINING">Î™ÏƒÎ¿ÏÏÎ¿Ï€Î¯Î±</option>
                                        <option value="CORE_TRAINING">Core</option>
                                        <option value="MUSCLE_BUILDING">ÎœÏ…ÏŠÎºÎ® Î‘Î½Î¬Ï€Ï„Ï…Î¾Î·</option>
                                        <option value="WEIGHT_LOSS">Î‘Ï€ÏÎ»ÎµÎ¹Î± Î’Î¬ÏÎ¿Ï…Ï‚</option>
                                        <option value="OUTDOOR_TRAINING">Î¥Ï€Î±Î¯Î¸ÏÎ¹Î±</option>
                                        <option value="GENERAL_FITNESS">Î“ÎµÎ½Î¹ÎºÎ® Î¦Ï…ÏƒÎ¹ÎºÎ® ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
                                <textarea class="form-control form-control-sm" name="notes" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-dark btn-sm">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î®</button>
                        </form>
                        <div th:if="${progressMessage}" class="alert alert-success mt-2" th:text="${progressMessage}"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î ÏÎ¿ÏŒÎ´Î¿Ï…</h6>
                        <div th:if="${progressEntries != null and !progressEntries.isEmpty()}">
                            <div th:each="entry : ${progressEntries}" class="border-start border-dark ps-2 mb-2">
                                <small><strong th:text="${entry.date}">Date</strong></small>
                                <span th:if="${entry.weight != null}" th:text="${' - Î’Î¬ÏÎ¿Ï‚: ' + entry.weight + ' kg'}"></span>
                                <span th:if="${entry.workoutDuration != null}" th:text="${' - Î”Î¹Î¬ÏÎºÎµÎ¹Î±: ' + entry.workoutDuration + ' Î»ÎµÏ€Ï„Î¬'}"></span>
                                <br th:if="${entry.trainingType != null or entry.notes != null}"/>
                                <small th:if="${entry.trainingType != null}" class="text-muted" th:text="${'Î•Î¯Î´Î¿Ï‚: ' + entry.trainingType}"></small>
                                <small th:if="${entry.notes != null}" class="text-muted" th:text="${' - ' + entry.notes}"></small>
                            </div>
                        </div>
                        <p th:if="${progressEntries == null or progressEntries.isEmpty()}" class="text-muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

</div>

<!-- Weather Modal -->
<div class="modal fade" id="weatherModal" tabindex="-1" aria-labelledby="weatherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="weatherModalLabel">â˜€ï¸ Î ÏÏŒÎ²Î»ÎµÏˆÎ· ÎšÎ±Î¹ÏÎ¿Ï</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="weatherContent">
                <div class="text-center">
                    <div class="spinner-border text-dark" role="status">
                        <span class="visually-hidden">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Working days management
        let trainerWorkingDays = []; // Will be populated when trainer is selected
        let flatpickrInstance = null; // Store flatpickr instance

        const scheduledDateInput = document.getElementById('scheduledDate');
        const scheduledTimeInput = document.getElementById('scheduledTime');
        const scheduledAtHidden = document.getElementById('scheduledAt');

        // Initialize Flatpickr
        if (scheduledDateInput) {
            flatpickrInstance = flatpickr(scheduledDateInput, {
                dateFormat: "Y-m-d",
                minDate: "today",
                locale: {
                    firstDayOfWeek: 1, // Monday
                    weekdays: {
                        shorthand: ['ÎšÏ…', 'Î”Îµ', 'Î¤Ï', 'Î¤Îµ', 'Î Îµ', 'Î Î±', 'Î£Î±'],
                        longhand: ['ÎšÏ…ÏÎ¹Î±ÎºÎ®', 'Î”ÎµÏ…Ï„Î­ÏÎ±', 'Î¤ÏÎ¯Ï„Î·', 'Î¤ÎµÏ„Î¬ÏÏ„Î·', 'Î Î­Î¼Ï€Ï„Î·', 'Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®', 'Î£Î¬Î²Î²Î±Ï„Î¿']
                    },
                    months: {
                        shorthand: ['Î™Î±Î½', 'Î¦ÎµÎ²', 'ÎœÎ±Ï', 'Î‘Ï€Ï', 'ÎœÎ¬Î¹', 'Î™Î¿ÏÎ½', 'Î™Î¿ÏÎ»', 'Î‘ÏÎ³', 'Î£ÎµÏ€', 'ÎŸÎºÏ„', 'ÎÎ¿Î­', 'Î”ÎµÎº'],
                        longhand: ['Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚', 'Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚', 'ÎœÎ¬ÏÏ„Î¹Î¿Ï‚', 'Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚', 'ÎœÎ¬Î¹Î¿Ï‚', 'Î™Î¿ÏÎ½Î¹Î¿Ï‚', 'Î™Î¿ÏÎ»Î¹Î¿Ï‚', 'Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚', 'Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚', 'ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚', 'ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚', 'Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚']
                    }
                },
                disable: [
                    function(date) {
                        // Disable dates based on trainer's working days
                        if (trainerWorkingDays.length === 0) {
                            return false; // Don't disable anything if no trainer selected
                        }

                        const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
                        const isoDayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek; // Convert to ISO (1=Monday, 7=Sunday)

                        // Return true to DISABLE the date (if it's NOT in working days)
                        return !trainerWorkingDays.includes(isoDayOfWeek);
                    }
                ],
                onChange: function(selectedDates, dateStr, instance) {
                    updateHiddenDateTime();
                }
            });
        }

        // Time picker with Flatpickr (only hours from 09:00 to 21:00)
        if (scheduledTimeInput) {
            flatpickr(scheduledTimeInput, {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                minTime: "09:00",
                maxTime: "21:00",
                minuteIncrement: 60, // Only show full hours
                defaultHour: 9,
                onChange: function(selectedDates, dateStr, instance) {
                    updateHiddenDateTime();
                }
            });
        }

        // Combine date + time into hidden datetime field
        function updateHiddenDateTime() {
            const date = scheduledDateInput.value;
            const time = scheduledTimeInput.value;

            if (date && time) {
                scheduledAtHidden.value = `${date}T${time}`;
            } else {
                scheduledAtHidden.value = '';
            }
        }

        // Show/hide location fields for outdoor training & load working days
        const trainerSelect = document.getElementById('trainerSelect');
        const locationFields = document.getElementById('locationFields');
        const hiddenLatitude = document.getElementById('hiddenLatitude');
        const hiddenLongitude = document.getElementById('hiddenLongitude');

        if (trainerSelect && locationFields) {
            trainerSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const specialisation = selectedOption.dataset.specialisation;
                const trainerId = this.value;

                // Reset working days
                trainerWorkingDays = [];
                if (flatpickrInstance) {
                    flatpickrInstance.clear(); // Clear selected date
                }

                // Fetch trainer's working days
                if (trainerId) {
                    fetch(`/api/trainers/${trainerId}/working-days`)
                        .then(response => response.json())
                        .then(data => {
                            trainerWorkingDays = data;
                            console.log('Trainer working days:', trainerWorkingDays);

                            // Update Flatpickr to reflect new working days
                            if (flatpickrInstance) {
                                flatpickrInstance.redraw(); // Redraw calendar with new disabled dates
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching working days:', error);
                        });
                }

                // Handle outdoor location fields
                if (specialisation && specialisation.includes('Outdoor')) {
                    locationFields.style.display = 'block';
                } else {
                    locationFields.style.display = 'none';
                    // Clear location when not outdoor
                    const locationInput = document.getElementById('locationInput');
                    const locationFeedback = document.getElementById('locationFeedback');
                    if (locationInput) locationInput.value = '';
                    if (locationFeedback) locationFeedback.textContent = '';
                    if (hiddenLatitude) hiddenLatitude.value = '';
                    if (hiddenLongitude) hiddenLongitude.value = '';
                }
            });
        }

        // Postal code lookup
        const lookupPostalCodeBtn = document.getElementById('lookupPostalCode');
        const postalCodeInput = document.getElementById('postalCodeInput');
        const postalCodeFeedback = document.getElementById('postalCodeFeedback');

        if (lookupPostalCodeBtn && postalCodeInput) {
            lookupPostalCodeBtn.addEventListener('click', function() {
                const postalCode = postalCodeInput.value.trim();

                if (!postalCode) {
                    postalCodeFeedback.className = 'form-text text-danger';
                    postalCodeFeedback.textContent = 'Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ ÏŒÎ½Î¿Î¼Î± Ï€ÎµÏÎ¹Î¿Ï‡Î®Ï‚ Î® Ï€ÏŒÎ»Î·Ï‚';
                    return;
                }

                // Show loading
                lookupPostalCodeBtn.disabled = true;
                lookupPostalCodeBtn.textContent = 'â³ Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...';
                postalCodeFeedback.className = 'form-text text-muted';
                postalCodeFeedback.textContent = 'Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±Ï‚...';

                // Call integration service geocoding API
                fetch('http://localhost:8081/api/integration/geocoding?postalCode=' + postalCode + '&country=GR')
                    .then(response => response.json())
                    .then(data => {
                        lookupPostalCodeBtn.disabled = false;
                        lookupPostalCodeBtn.textContent = 'ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·';

                        if (data.found && data.latitude && data.longitude) {
                            hiddenLatitude.value = data.latitude;
                            hiddenLongitude.value = data.longitude;
                            postalCodeFeedback.className = 'form-text text-success';
                            postalCodeFeedback.textContent = 'âœ“ Î’ÏÎ­Î¸Î·ÎºÎµ: ' + data.name + ' (' + data.latitude.toFixed(4) + ', ' + data.longitude.toFixed(4) + ')';
                        } else {
                            postalCodeFeedback.className = 'form-text text-danger';
                            postalCodeFeedback.textContent = 'âœ— ' + (data.error || 'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±');
                            hiddenLatitude.value = '';
                            hiddenLongitude.value = '';
                        }
                    })
                    .catch(error => {
                        lookupPostalCodeBtn.disabled = false;
                        lookupPostalCodeBtn.textContent = 'ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·';
                        postalCodeFeedback.className = 'form-text text-danger';
                        postalCodeFeedback.textContent = 'âœ— Î£Ï†Î¬Î»Î¼Î±: Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Ï„Î¿ integration-service Ï„ÏÎ­Ï‡ÎµÎ¹ ÏƒÏ„Î¿ port 8081';
                        console.error('Geocoding error:', error);
                    });
            });

            // Allow Enter key to trigger lookup
            postalCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    lookupPostalCodeBtn.click();
                }
            });
        }

        // AJAX booking form submission
        const bookingForm = document.getElementById('bookingForm');
        const bookingMessage = document.getElementById('bookingMessage');

        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(bookingForm);

                // Auto-set trainingType to OUTDOOR_TRAINING if outdoor trainer is selected
                const trainerSelect = document.getElementById('trainerSelect');
                const selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
                const specialisation = selectedOption.dataset.specialisation;

                if (specialisation && specialisation.includes('Outdoor')) {
                    formData.append('trainingType', 'OUTDOOR_TRAINING');

                    // Validate that location is provided for outdoor training
                    if (!hiddenLatitude.value || !hiddenLongitude.value) {
                        bookingMessage.style.display = 'block';
                        bookingMessage.className = 'mt-2 text-danger small';
                        bookingMessage.textContent = 'Î Î±ÏÎ±ÎºÎ±Î»Ï Î´ÏÏƒÏ„Îµ Ï„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î® ÎºÎ±Î¹ Ï€Î±Ï„Î®ÏƒÏ„Îµ Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î³Î¹Î± Ï…Ï€Î±Î¯Î¸ÏÎ¹Î± Ï€ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ·';
                        return;
                    }
                }

                fetch('/appointments/new', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            bookingMessage.style.display = 'block';
                            bookingMessage.className = 'mt-2 text-muted small';
                            bookingMessage.textContent = data.message;
                            bookingForm.reset();
                            locationFields.style.display = 'none';
                            // Refresh page after 2 seconds to show new appointment
                            setTimeout(() => location.reload(), 2000);
                        } else {
                            bookingMessage.style.display = 'block';
                            bookingMessage.className = 'mt-2 text-danger small';
                            bookingMessage.textContent = data.error || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎºÏÎ¬Ï„Î·ÏƒÎ·';
                        }
                    })
                    .catch(err => {
                        bookingMessage.style.display = 'block';
                        bookingMessage.className = 'mt-2 text-danger small';
                        bookingMessage.textContent = 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎºÏÎ¬Ï„Î·ÏƒÎ·';
                    });
            });
        }

        // Weather button handlers
        const weatherButtons = document.querySelectorAll('.weather-btn');
        const weatherModal = new bootstrap.Modal(document.getElementById('weatherModal'));
        const weatherContent = document.getElementById('weatherContent');

        weatherButtons.forEach(button => {
            button.addEventListener('click', function() {
                const appointmentId = this.dataset.appointmentId;

                // Show modal with loading spinner
                weatherContent.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-dark" role="status">
                            <span class="visually-hidden">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</span>
                        </div>
                        <p class="mt-2">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï€ÏÏŒÎ²Î»ÎµÏˆÎ·Ï‚ ÎºÎ±Î¹ÏÎ¿Ï...</p>
                    </div>
                `;
                weatherModal.show();

                // Fetch weather data
                fetch('/api/weather/appointment/' + appointmentId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            weatherContent.innerHTML = `
                                <div class="alert alert-warning">
                                    <strong>âš ï¸ ${data.error}</strong>
                                    ${data.message ? '<p class="mb-0 mt-2">' + data.message + '</p>' : ''}
                                </div>
                            `;
                        } else {
                            const suitableIcon = data.isSuitable ? 'âœ…' : 'âš ï¸';
                            const suitableText = data.isSuitable ? 'ÎšÎ±Ï„Î¬Î»Î»Î·Î»Î¿Ï‚ Î³Î¹Î± Ï…Ï€Î±Î¯Î¸ÏÎ¹Î± Ï€ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ·' : 'ÎœÎ· Î¹Î´Î±Î½Î¹ÎºÏŒÏ‚ Î³Î¹Î± Ï…Ï€Î±Î¯Î¸ÏÎ¹Î± Ï€ÏÎ¿Ï€ÏŒÎ½Î·ÏƒÎ·';
                            const suitableClass = data.isSuitable ? 'success' : 'warning';

                            weatherContent.innerHTML = `
                                <div class="card border-0">
                                    <div class="card-body">
                                        <h6 class="card-subtitle mb-3 text-muted">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${data.date}</h6>

                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <div class="text-center p-3 bg-light rounded">
                                                    <div class="text-danger fs-4">ğŸŒ¡ï¸</div>
                                                    <div class="fw-bold">${data.temperatureMax}Â°C</div>
                                                    <small class="text-muted">Max</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-center p-3 bg-light rounded">
                                                    <div class="text-primary fs-4">ğŸŒ¡ï¸</div>
                                                    <div class="fw-bold">${data.temperatureMin}Â°C</div>
                                                    <small class="text-muted">Min</small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3 p-3 bg-light rounded">
                                            <div class="d-flex align-items-center">
                                                <span class="fs-4 me-2">ğŸ’§</span>
                                                <div>
                                                    <div class="fw-bold">Î’ÏÎ¿Ï‡ÏŒÏ€Ï„Ï‰ÏƒÎ·</div>
                                                    <div>${data.precipitationSum} mm</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3 p-3 bg-light rounded">
                                            <div class="fw-bold mb-1">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</div>
                                            <div>${data.weatherDescription}</div>
                                        </div>

                                        <div class="alert alert-${suitableClass} mb-0">
                                            <strong>${suitableIcon} ${suitableText}</strong>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        weatherContent.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>âŒ Î£Ï†Î¬Î»Î¼Î±</strong>
                                <p class="mb-0 mt-2">Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Î»Î®ÏˆÎ· Ï„Î·Ï‚ Ï€ÏÏŒÎ²Î»ÎµÏˆÎ·Ï‚ ÎºÎ±Î¹ÏÎ¿Ï.
                                Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Ï„Î¿ integration-service Ï„ÏÎ­Ï‡ÎµÎ¹.</p>
                            </div>
                        `;
                    });
            });
        });
    });
</script>
<form id="autoLogoutForm" th:action="@{/logout}" method="post" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
</form>
<script>
    (function () {
        function isBackForward() {
            const nav = performance.getEntriesByType && performance.getEntriesByType("navigation")[0];
            return nav && nav.type === "back_forward";
        }

        function logoutNow() {
            const f = document.getElementById("autoLogoutForm");
            if (f) f.submit();
            else window.location.replace("/login");
        }

        window.addEventListener("pageshow", function (e) {
            if (e.persisted || isBackForward()) {
                logoutNow();
            }
        });

        // Î¼ÎµÎ¹ÏÎ½ÎµÎ¹ BFCache ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î¿Ï…Ï‚ browsers
        window.addEventListener("unload", function(){});
    })();
</script>

</body>
</html>
