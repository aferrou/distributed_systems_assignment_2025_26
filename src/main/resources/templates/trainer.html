<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" lang="el" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <title>Trainer Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

    <style>
        #calendar {
            max-width: 900px;
            margin: 20px auto;
        }
    </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">

        <a class="navbar-brand" href="#">Trainer Dashboard</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">

            <!-- Left menu -->
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#availability">Διαθεσιμότητα</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#appointments">Ραντεβού</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#notes">Σημειώσεις</a>
                </li>
            </ul>

            <!-- Trainer Info (Right menu) -->
            <ul class="navbar-nav" th:if="${trainer != null}">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <span th:text="${trainer.firstName + ' ' + trainer.lastName}">Trainer info</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="dropdown-item">
                            <strong>Email:</strong>
                            <span th:text="${trainer.emailAddress}"></span>
                        </li>
                        <li class="dropdown-item">
                            <strong>Τηλέφωνο:</strong>
                            <span th:text="${trainer.mobilePhoneNumber}"></span>
                        </li>
                        <li class="dropdown-item">
                            <strong>Ειδικότητα:</strong>
                            <span th:text="${trainer.specialisation}"></span>
                        </li>
                        <li class="dropdown-item">
                            <strong>Περιοχή:</strong>
                            <span th:text="${trainer.trainArea}"></span>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="/logout">Αποσύνδεση</a>
                        </li>
                    </ul>
                </li>
            </ul>

        </div>
    </div>
</nav>

<!-- Page Container -->
<div class="container mt-4">

    <!-- Availability Section -->
    <section id="availability" class="mb-5">
        <h2>Διαθεσιμότητα</h2>
        <div id="calendar"></div>
        <button id="save-availability" class="btn btn-primary mt-3">
            Αποθήκευση Διαθεσιμότητας
        </button>
    </section>

</div>
<!-- Appointments Section -->
<!--
<section id="appointments" class="mb-5">
    <h2>Ραντεβού</h2>
    <div class="list-group">
        <div class="list-group-item" th:each="appointment : ${appointments}">
            <div class="d-flex justify-content-between">
                <div>
                    <h5 th:text="${appointment.userName}">User Name</h5>
                    <p th:text="${appointment.dateTime}">Date and Time</p>
                </div>
                <div>
                    <button class="btn btn-success me-2" th:onclick="'acceptAppointment(\'' + ${appointment.id} + '\')'">Αποδοχή</button>
                    <button class="btn btn-danger" th:onclick="'cancelAppointment(\'' + ${appointment.id} + '\')'">Ακύρωση</button>
                </div>
            </div>
        </div>
    </div>
</section>-->
<section id="appointments" class="mb-5"  style="margin-left: 90px; margin-right: 100px;">
    <h2>Ραντεβού</h2>

    <div class="list-group">
        <!-- Placeholder appointment 1 -->
        <div class="list-group-item">
            <div class="d-flex justify-content-between">
                <div>
                    <h5>Γεράσιμος Καπατσώρης</h5>
                    <p>2026-01-05 10:00</p>
                </div>
                <div>
                    <button class="btn btn-success me-2" onclick="acceptAppointment(1)">Αποδοχή</button>
                    <button class="btn btn-danger" onclick="cancelAppointment(1)">Ακύρωση</button>
                </div>
            </div>
        </div>

</section>



<!-- Notes Section -->
<!--
<section id="notes" class="mb-5">
    <h2>Σημειώσεις Προπόνησης</h2>
    <div class="mb-3">
        <label for="user-select" class="form-label">Επιλογή Χρήστη</label>
        <select id="user-select" class="form-select" th:field="*{selectedUser}">
            <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.name}">User Name</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="training-notes" class="form-label">Σημειώσεις</label>
        <textarea class="form-control" id="training-notes" rows="5" th:field="*{trainingNotes}" placeholder="Καταγράψτε σημειώσεις..."></textarea>
    </div>
    <button id="save-notes" class="btn btn-primary">Αποθήκευση Σημειώσεων</button>
</section>

-->
<section id="notes" class="mb-5" style="margin-left: 90px; margin-right: 100px;">
    <h2>Σημειώσεις Προπόνησης</h2>

    <div class="mb-3">
        <label for="user-select" class="form-label">Επιλογή Χρήστη</label>
        <select id="user-select" class="form-select">
            <!-- placeholder options -->
            <option value="1">Γεράσιμος Καπατσώρης</option>
            <option value="2">Cynthia</option>
            <option value="3">Άλλος Χρήστης</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="training-notes" class="form-label">Σημειώσεις</label>
        <textarea class="form-control" id="training-notes" rows="5" placeholder="Καταγράψτε σημειώσεις..."></textarea>
    </div>

    <button id="save-notes" class="btn btn-primary">Αποθήκευση Σημειώσεων</button>
</section>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<!-- Custom Scripts -->

<script>
    document.addEventListener('DOMContentLoaded', function () {

        let selectedRange = null;

        const calendar = new FullCalendar.Calendar(
            document.getElementById('calendar'),
            {
                initialView: 'timeGridWeek',
                selectable: true,
                selectMirror: true,
                editable: true, // enable drag & drop and resize
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay'
                },

                // Prevent selecting past dates
                validRange: {
                    start: new Date().toISOString().split('T')[0]
                },

                // Prevent overlaps visually
                eventOverlap: false,
                selectOverlap: false,

                // When user selects a new time slot
                select: function(info) {
                    selectedRange = info;
                },

                // Load existing availability
                events: function(fetchInfo, successCallback) {
                    fetch('/availability')
                        .then(res => res.json())
                        .then(data => {
                            successCallback(
                                data.map(a => ({
                                    id: a.id,
                                    start: a.startTime,
                                    end: a.endTime,
                                    backgroundColor: 'green',
                                    borderColor: 'green'
                                }))
                            );
                        });
                },

                // Event resized
                eventResize: function(info) {
                    updateAvailability(info.event, info.revert);
                },

                // Event dragged/dropped
                eventDrop: function(info) {
                    updateAvailability(info.event, info.revert);
                },

                // Click event → delete
                eventClick: function(info) {
                    if (confirm("Θέλεις να διαγράψεις αυτή τη διαθεσιμότητα;")) {
                        deleteAvailability(info.event);
                    }
                }
            }
        );

        calendar.render();

        // Save new availability
        document.getElementById('save-availability').addEventListener('click', function () {

            if (!selectedRange) {
                alert("Επίλεξε πρώτα ώρες");
                return;
            }

            const availability = {
                startTime: selectedRange.startStr,
                endTime: selectedRange.endStr
            };

            fetch('/availability', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(availability)
            })
                .then(async res => {
                    if (!res.ok) {
                        const message = await res.text();
                        throw new Error(message);
                    }
                    return res.json();
                })
                .then(saved => {
                    calendar.addEvent({
                        id: saved.id,
                        start: saved.startTime,
                        end: saved.endTime,
                        backgroundColor: 'green',
                        borderColor: 'green'
                    });
                    selectedRange = null;
                })
                .catch(err => {
                    alert("Error saving availability: " + err.message);
                });
        });

        // Update availability (PUT)
        function updateAvailability(event, revertFunc) {
            const updated = {
                startTime: event.start.toISOString(),
                endTime: event.end.toISOString()
            };

            fetch('/availability/' + event.id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(updated)
            })
                .then(async res => {
                    if (!res.ok) {
                        const message = await res.text();
                        throw new Error(message);
                    }
                })
                .catch(err => {
                    alert(err.message); // backend overlap message
                    revertFunc();       // ✅ revert to original state
                });
        }

        // Delete availability (DELETE)
        function deleteAvailability(event) {
            fetch('/availability/' + event.id, {
                method: 'DELETE'
            })
                .then(res => res.text())
                .then(msg => {
                    if (msg.startsWith("Deleted")) {
                        event.remove(); // remove from calendar UI
                    } else {
                        alert(msg);
                    }
                });
        }

    });
</script>





</body>
</html>