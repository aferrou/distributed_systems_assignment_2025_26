<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" lang="el" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Trainer Dashboard - FitTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    #calendar { max-width: 900px; margin: 20px auto; }
    .card { border: 1px solid #dee2e6; }
    .legend { display: flex; gap: 20px; margin-bottom: 10px; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-box { width: 20px; height: 20px; border-radius: 3px; }
  </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/trainer">Trainer Dashboard</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="#availability">Ημερολόγιο</a></li>
        <li class="nav-item"><a class="nav-link" href="#appointments">Ραντεβού</a></li>
        <li class="nav-item"><a class="nav-link" href="#notes">Σημειώσεις</a></li>
      </ul>
      <ul class="navbar-nav" th:if="${trainer != null}">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <span th:text="${trainer.firstName + ' ' + trainer.lastName}">Trainer</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li class="dropdown-item"><strong>Email:</strong> <span th:text="${trainer.emailAddress}"></span></li>
            <li class="dropdown-item" th:if="${trainer.specialisation}"><strong>Ειδικότητα:</strong> <span th:text="${trainer.specialisation}"></span></li>
            <li class="dropdown-item" th:if="${trainer.trainArea}"><strong>Περιοχή:</strong> <span th:text="${trainer.trainArea}"></span></li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <form method="post" th:action="@{/logout}" style="display: inline;">
                <button type="submit" class="dropdown-item text-danger">Αποσύνδεση</button>
              </form>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">

  <!-- Calendar Section -->
  <section id="availability" class="mb-5">
    <h4>Ημερολόγιο</h4>
    <p class="text-muted">Διαθεσιμότητα και ραντεβού.</p>

    <!-- Legend -->
    <div class="legend">
      <div class="legend-item">
        <div class="legend-box" style="background-color: #212529;"></div>
        <span>Διαθεσιμότητα</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background-color: #ffc107;"></div>
        <span>Ραντεβού (Σε αναμονή)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background-color: #198754;"></div>
        <span>Ραντεβού (Επιβεβαιωμένο)</span>
      </div>
    </div>

    <div id="calendar"></div>
    <button id="save-availability" class="btn btn-dark mt-3">Αποθήκευση Διαθεσιμότητας</button>
  </section>

  <!-- Appointments Section -->
  <section id="appointments" class="mb-5">
    <h4>Ραντεβού</h4>

    <div class="alert alert-secondary" th:if="${#lists.isEmpty(appointments)}">
      Δεν υπάρχουν ραντεβού.
    </div>

    <div class="list-group" th:if="${not #lists.isEmpty(appointments)}">
      <div class="list-group-item" th:each="appointment : ${appointments}">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong th:text="${appointment.user.firstName + ' ' + appointment.user.lastName}">User</strong>
            <br/>
            <small>
                            <span th:if="${appointment.scheduledAt != null}"
                                  th:text="${#temporals.format(appointment.scheduledAt, 'dd/MM/yyyy HH:mm')}">Date</span>
              <span th:if="${appointment.scheduledAt == null}">Χωρίς ημερομηνία</span>
              -
              <span class="badge bg-warning text-dark" th:if="${appointment.status.name() == 'REQUESTED'}">Σε αναμονή</span>
              <span class="badge bg-dark" th:if="${appointment.status.name() == 'CONFIRMED'}">Επιβεβαιωμένο</span>
              <span class="badge bg-secondary" th:if="${appointment.status.name() == 'COMPLETED'}">Ολοκληρώθηκε</span>
            </small>
          </div>
          <div th:id="'appt-actions-' + ${appointment.id}">
            <button th:if="${appointment.status.name() == 'REQUESTED'}"
                    type="button"
                    class="btn btn-dark btn-sm confirm-btn"
                    th:data-id="${appointment.id}"
                    th:data-csrf="${_csrf.token}">Αποδοχή</button>
            <span th:if="${appointment.status.name() == 'REQUESTED'}"
                  th:id="'confirm-msg-' + ${appointment.id}"
                  class="text-success small ms-2"
                  style="display: none;">✓</span>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section id="notes" class="mb-5">

    <h4>Σημειώσεις</h4>
    <p class="text-muted">Διαχείριση σημειώσεων ανά χρήστη.</p>


    <div class="card">
      <div class="card-body">

        <!-- Select user -->
        <form method="get" action="/trainer" class="row g-2 align-items-end mb-3">
          <div class="col-md-6">
            <label for="userSelect" class="form-label">Επιλογή χρήστη</label>
            <select id="userSelect" name="userId" class="form-select" onchange="this.form.submit()">
              <option value="">-- choose --</option>
              <option th:each="u : ${users}"
                      th:value="${u.id}"
                      th:selected="${selectedUserId} == ${u.id}"
                      th:text="${u.firstName + ' ' + u.lastName}">
              </option>
            </select>
          </div>
        </form>

        <div th:if="${selectedUserId != null}">
          <!-- Add note -->
          <form method="post" action="/trainer/notes" class="mb-4">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <input type="hidden" name="userId" th:value="${selectedUserId}" />

            <label class="form-label">Νέα σημείωση</label>
            <textarea name="content" rows="4" maxlength="2000" required
                      class="form-control mb-2"
                      placeholder="Γράψε μια σημείωση..."></textarea>

            <button type="submit" class="btn btn-dark">Προσθήκη</button>
          </form>


          <!-- Saved notes -->
          <h5 class="mb-2">Αποθηκευμένες σημειώσεις</h5>

          <div th:if="${#lists.isEmpty(notes)}" class="text-muted">
            Δεν υπάρχουν σημειώσεις ακόμα.
          </div>

          <ul th:if="${!#lists.isEmpty(notes)}" class="list-group">
            <li th:each="n : ${notes}" class="list-group-item">
              <div class="small text-muted mb-1" th:text="${n.createdAt}"></div>
              <div th:text="${n.content}"></div>
            </li>
          </ul>
        </div>

        <div th:if="${selectedUserId == null}" class="text-muted">
          Επέλεξε έναν χρήστη για να δεις ή να προσθέσεις σημειώσεις.
        </div>

      </div>
    </div>
  </section>
</div>

<!-- Pass appointments data to JavaScript -->
<script th:inline="javascript">
  var appointmentsData = /*[[${appointments}]]*/ [];
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let selectedRange = null;

    // Convert appointments to calendar events
    const appointmentEvents = (appointmentsData || [])
            .filter(a => a.scheduledAt != null)
            .map(a => ({
              id: 'appt-' + a.id,
              title: a.user.firstName + ' ' + a.user.lastName,
              start: a.scheduledAt,
              end: new Date(new Date(a.scheduledAt).getTime() + 60*60*1000).toISOString(), // 1 hour duration
              backgroundColor: a.status === 'REQUESTED' ? '#ffc107' : (a.status === 'CONFIRMED' ? '#198754' : '#6c757d'),
              borderColor: a.status === 'REQUESTED' ? '#ffc107' : (a.status === 'CONFIRMED' ? '#198754' : '#6c757d'),
              textColor: a.status === 'REQUESTED' ? '#000' : '#fff',
              editable: false
            }));

    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'timeGridWeek',
      selectable: true,
      selectMirror: true,
      editable: true,
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
      validRange: { start: new Date().toISOString().split('T')[0] },
      eventOverlap: false,
      selectOverlap: false,
      select: function(info) { selectedRange = info; },
      events: function(fetchInfo, successCallback) {
        // Load availability
        fetch('/availability').then(res => res.json()).then(data => {
          const availabilityEvents = data.map(a => ({
            id: a.id,
            start: a.startTime,
            end: a.endTime,
            backgroundColor: '#212529',
            borderColor: '#212529',
            title: 'Διαθέσιμος'
          }));
          // Combine availability + appointments
          successCallback([...availabilityEvents, ...appointmentEvents]);
        });
      },
      eventResize: function(info) {
        // Only allow resize for availability events (not appointments)
        if (String(info.event.id).startsWith('appt-')) {
          info.revert();
          return;
        }
        updateAvailability(info.event, info.revert);
      },
      eventDrop: function(info) {
        // Only allow drag for availability events (not appointments)
        if (String(info.event.id).startsWith('appt-')) {
          info.revert();
          return;
        }
        updateAvailability(info.event, info.revert);
      },
      eventClick: function(info) {
        // Only allow delete for availability events
        if (String(info.event.id).startsWith('appt-')) {
          alert('Για διαχείριση ραντεβού χρησιμοποιήστε τη λίστα παρακάτω.');
          return;
        }
        if (confirm("Διαγραφή αυτής της διαθεσιμότητας;")) deleteAvailability(info.event);
      }
    });
    calendar.render();

    document.getElementById('save-availability').addEventListener('click', function () {
      if (!selectedRange) { alert("Επιλέξτε πρώτα ώρες"); return; }
      fetch('/availability', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ startTime: selectedRange.startStr, endTime: selectedRange.endStr })
      }).then(async res => {
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }).then(saved => {
        calendar.addEvent({ id: saved.id, start: saved.startTime, end: saved.endTime, backgroundColor: '#212529', borderColor: '#212529', title: 'Διαθέσιμος' });
        selectedRange = null;
        calendar.unselect();
      }).catch(err => alert("Σφάλμα: " + err.message));
    });

    function updateAvailability(event, revertFunc) {
      fetch('/availability/' + event.id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ startTime: event.start.toISOString(), endTime: event.end.toISOString() })
      }).then(async res => { if (!res.ok) throw new Error(await res.text()); })
              .catch(err => { alert(err.message); revertFunc(); });
    }

    function deleteAvailability(event) {
      fetch('/availability/' + event.id, { method: 'DELETE' }).then(res => res.text()).then(msg => {
        if (msg.startsWith("Deleted")) event.remove();
        else alert(msg);
      });
    }

    // AJAX confirm appointment
    document.querySelectorAll('.confirm-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.dataset.id;
        const csrf = this.dataset.csrf;
        const button = this;
        const msgSpan = document.getElementById('confirm-msg-' + id);

        const formData = new FormData();
        formData.append('_csrf', csrf);

        fetch('/appointments/' + id + '/confirm', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    // Hide button, show confirmation
                    button.style.display = 'none';
                    if (msgSpan) {
                      msgSpan.style.display = 'inline';
                    }
                    // Update badge
                    const listItem = button.closest('.list-group-item');
                    if (listItem) {
                      const badge = listItem.querySelector('.badge');
                      if (badge) {
                        badge.className = 'badge bg-dark';
                        badge.textContent = 'Επιβεβαιωμένο';
                      }
                    }
                    // Update calendar event color
                    const calEvent = calendar.getEventById('appt-' + id);
                    if (calEvent) {
                      calEvent.setProp('backgroundColor', '#198754');
                      calEvent.setProp('borderColor', '#198754');
                      calEvent.setProp('textColor', '#fff');
                    }
                  }
                })
                .catch(err => {
                  alert('Σφάλμα κατά την αποδοχή');
                });
      });
    });
  });
</script>
</body>
</html>
